<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>BPS Random-Walkモデルの数式解説（修正版）</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Meiryo, 'Hiragino Sans', 'Yu Gothic', sans-serif;
            line-height: 1.8;
            color: #333;
            background-color: #fdfdfd;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 1.5em;
        }
        h1 {
            text-align: center;
            border-bottom: 3px solid #2980b9;
        }
        code {
            background-color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
        }
        .mjx-chtml {
            padding: 1.2em 0;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BPS Random-Walkモデルの数式解説</h1>
        <p>
            このモデルは、複数のベースラインモデル（ここでは3因子モデルと1因子モデル）による**観測値の予測値**を、時間と共に変化する「重み」で動的に統合するための状態空間モデルです。重みと切片項がそれぞれランダムウォークに従うことで、時々刻々と変化するシステムを柔軟に表現します。
        </p>

        <h2>1. 記号の定義 (Notation)</h2>
        <ul>
            <li>\(y_t\): 時点 \(t\) における観測データベクトル (\(O \times 1\) 次元)。</li>
            <li>\(f_t\): 時点 \(t\) における各ベースラインモデルによる予測値 \(\hat{y}_t\) を列ベクトルとして並べた行列 (\(O \times J\) 次元)。今回の実装では、\(J=2\) であり、\(f_t = [\hat{y}_{t}^{(3fac)}, \hat{y}_{t}^{(1fac)}]\) となります。</li>
            <li>\(\beta_t\): 時点 \(t\) における予測値行列 \(f_t\) に対する重みベクトル (\(J \times 1\) 次元)。</li>
            <li>\(\alpha_t\): 時点 \(t\) における時変の切片項ベクトル (\(O \times 1\) 次元)。</li>
            <li>\(\epsilon_t, \eta_t, u_t\): それぞれ観測方程式、\(\beta_t\)の状態方程式、\(\alpha_t\)の状態方程式における誤差項。</li>
            <li>\(\Sigma, V, \tau^2\): それぞれ誤差項 \(\epsilon_t, \eta_t, u_t\) の分散共分散行列（または分散）。</li>
        </ul>

        <hr>

        <h2>2. 状態空間モデル (State-Space Model)</h2>
        <p>
            モデルは「観測方程式」と「状態方程式」の2つの主要な式で構成されます。
        </p>

        <h3>観測方程式 (Observation Equation)</h3>
        <p>
            観測データ \(y_t\) が、時変切片 \(\alpha_t\) と、各モデルの予測値 \(f_t\) を重み \(\beta_t\) で線形結合したものによってどのように生成されるかを示します。
        </p>
        \[
        y_t = \alpha_t + f_t \beta_t + \epsilon_t, \quad \epsilon_t \sim \mathcal{N}(0, \Sigma)
        \]
        <p>
            この式は、各時点の観測値が、ベースラインモデル群の予測値の加重平均（\(f_t \beta_t\)）と、システム全体のバイアス（\(\alpha_t\)）によって決まることを意味します。
        </p>

        <h3>状態方程式 (State Equations)</h3>
        <p>
            観測できない状態変数（\(\beta_t\) と \(\alpha_t\)）が時間と共にどのように変化するかを定義します。両者とも、前期の値にノイズが加わる**ランダムウォーク**に従うと仮定します。
        </p>
        <p>
            予測値の重み \(\beta_t\) の時間変化：
        </p>
        \[
        \beta_{t} = \beta_{t-1} + \eta_t, \quad \eta_t \sim \mathcal{N}(0, V)
        \]
        <p>
            時変切片 \(\alpha_t\) の時間変化：
        </p>
        \[
        \alpha_{t} = \alpha_{t-1} + u_t, \quad u_t \sim \mathcal{N}(0, \tau^2 I)
        \]
        <p>
            これらの式により、モデルは過去の重みや切片の情報を引き継ぎつつ、新しい情報に基づいて柔軟にその値を更新していくことができます。
        </p>

        <hr>

        <h2>3. パラメータの事前分布 (Priors)</h2>
        <p>
            ベイジアンモデリングでは、モデルのパラメータ（この場合は誤差の分散など）に対しても事前分布を設定します。
        </p>
        <ul>
            <li><b>重みの過程誤差 (V)</b>: \(V\) の対角要素 \(v_j\) (次元 \(J=2\)) は、対数正規分布に従うと仮定します。 \(\log(v_j) \sim \mathcal{N}(-2, 1)\)</li>
            <li><b>切片の過程誤差 (\(\tau^2\))</b>: \(\tau\) は、対数正規分布に従うと仮定します。 \(\log(\tau) \sim \mathcal{N}(-2, 1)\)</li>
            <li><b>観測誤差 (\(\Sigma\))</b>: \(\Sigma\) の対角要素 \(\sigma_k\) は、対数正規分布に従うと仮定します。 \(\log(\sigma_k) \sim \mathcal{N}(0, 1)\)</li>
            <li><b>状態の初期値 (\(\beta_1, \alpha_1\))</b>: \(\beta_1\) (次元 \(J=2\)) と \(\alpha_1\) は、それぞれ標準正規分布に従うと仮定します。\(\beta_1 \sim \mathcal{N}(0, I)\), \(\alpha_1 \sim \mathcal{N}(0, I)\)</li>
        </ul>
    </div>
</body>
</html>